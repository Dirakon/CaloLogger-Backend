name: unit-tests

on: [ push ]

jobs:
  tests:
    name: Unit tests
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v24
      - uses: cachix/cachix-action@v13
        with:
          name: poetry2nix
          signingKey: "VhaWuN3IyJVpWg+aZvTocVB+W8ziZKKRGLKR53Pkld3YRZxYOUfXZf0fvqF+LkqVW0eA60trVd5vsqNONpX9Hw=="
      - run: |
          cp .env.test .env
      #          TODO: increase failure coverage percentage after adding integration tests
      - run: |
          nix develop --command bash -c 'poetry install'
      - run: |
          nix develop --command bash -c 'poetry run pytest --cov app/ --cov-branch --cov-report=term --cov-fail-under=60'